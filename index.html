<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Form Sarana Mesin COU</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

<style>
body{
  background:#f4f6f9;
}
.card{
  border-radius:16px;
}
.machine-card{
  background:#f8f9fa;
  border:1px dashed #ced4da;
  padding:15px;
  border-radius:12px;
  margin-bottom:10px;
}

/* LOADING OVERLAY */
#loadingOverlay{
  position:fixed;
  inset:0;
  background:rgba(255,255,255,0.85);
  z-index:2000;
  display:none;
  align-items:center;
  justify-content:center;
  flex-direction:column;
}

.spinner-border{
  width:4rem;
  height:4rem;
}
</style>
</head>

<body>

<!-- LOADING OVERLAY -->
<div id="loadingOverlay">
  <div class="spinner-border text-primary"></div>
  <p class="mt-3 fw-semibold text-primary">
    Mengirim data, mohon tunggu...
  </p>
</div>

<div class="container py-4">
  <div class="card shadow">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">
        <i class="bi bi-clipboard-data"></i> Form Evaluasi Sarana Mesin COU
      </h5>
    </div>

    <div class="card-body">

      <div class="mb-3">
        <label class="form-label fw-bold">Region</label>
        <select id="region" class="form-select" required>
          <option value="">-- Pilih Region --</option>
          <option>Region 1</option>
          <option>Region 2</option>
          <option>Region 3</option>
          <option>Region 4</option>
          <option>Region 5</option>
          <option>Region 6</option>
          <option>Region 7</option>
          <option>Region 8</option>
          <option>Region 9</option>
          <option>Region 10</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label fw-bold">Nama COU</label>
        <input type="text" id="namaCOU" class="form-control" required>
      </div>

      <h6 class="fw-bold mt-4">
        <i class="bi bi-cpu"></i> Data Mesin
      </h6>

      <div id="mesinContainer"></div>

      <p class="fw-bold text-danger fst-italic">
        Untuk menambahkan data mesin lainnya silahkan klik tombol tambah mesin !
      </p>

      <button class="btn btn-outline-primary btn-sm mt-2" onclick="tambahMesin()">
        <i class="bi bi-plus-circle"></i> Tambah Data Mesin
      </button>

      <div class="mt-4">
        <label class="form-label fw-bold">Apakah sarana mesin sudah cukup?</label>
        <select id="kecukupan" class="form-select" required>
          <option value="">-- Pilih --</option>
          <option value="Cukup">Cukup</option>
          <option value="Kurang">Kurang</option>
        </select>
      </div>

      <div class="mt-3">
        <label class="form-label fw-bold">Saran / Usulan</label>
        <textarea id="saran" class="form-control" rows="3" ></textarea>
      </div>

    </div>

    <div class="card-footer text-end">
      <button id="btnSave" class="btn btn-success" onclick="simpanData()">
        <i class="bi bi-save"></i> Save Data
      </button>
    </div>
  </div>
</div>

<!-- MODAL SUCCESS -->
<div class="modal fade" id="successModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center">
      <div class="modal-body p-4">
        <i class="bi bi-check-circle-fill text-success display-4"></i>
        <h5 class="mt-3">Data Berhasil Disimpan</h5>
        <p class="text-muted">Terima kasih, data telah dikirim.</p>
        <button class="btn btn-primary" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<script>
const webAppURL = "https://script.google.com/macros/s/AKfycbzvtkoSNHyJuP2Ub97ZMlDvL6Org7QySMnoiefxUwFA9Y7auSK-VpLe2zuGP0dNROtvTg/exec";

/* === FUNGSI ASLI: TAMBAH MESIN (TETAP ADA) === */
function tambahMesin() {
  const div = document.createElement("div");
  div.className = "machine-card mb-4";

  div.innerHTML = `
    <div class="row g-2 mb-2">

      <div class="col-md-2">
        <label class="form-label small fw-bold">Jenis Mesin</label>
        <select class="form-select jenis" required>
          <option value="">--Jenis Mesin--</option>
          <option>MHU</option>
          <option>MSU</option>
          <option>MPU</option>
          <option>MHUL</option>
          <option>Lainnya</option>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label small fw-bold">Merk</label>
        <select class="form-select merk" required>
          <option value="">--Merk--</option>
          <option>Norxel</option>
          <option>Glory</option>
          <option>Hitachi</option>
          <option>Tronix</option>
          <option>GND</option>
          <option>Scan Coin</option>
          <option>Cash Tek</option>
          <option>LEA</option>
          <option>Cash Quip</option>
          <option>Lainnya</option>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label small fw-bold">Type</label>
        <select class="form-select type" required>
          <option value="">--Type--</option>
          <option>Norxel-DLRX-7500</option>
          <option>Norxel-DLRX-5500</option>
          <option>Norxel-NX-9300</option>
          <option>Norxel-NX-7700</option>
          <option>Norxel-NX-5500HS</option>

          <option>Glory-UW-F8</option>
          <option>Glory-UW-600</option>
          <option>Glory-UW-500</option>
          <option>Glory-UW-F4</option>
          <option>Glory-USF-100</option>
          <option>Glory-USF-52</option>
          <option>Glory-GFB-800</option>
          <option>Glory-GNH-710</option>

          <option>Hitachi-MS-4200</option>
          <option>Hitachi-iH-210</option>
          <option>Hitachi-iH-110F</option>

          <option>Tronix-ST-150NF</option>
          <option>Tronix-TX-100</option>
          <option>Tronix-SH-07P ( single Pocket ) </option>

          <option>GnD-C4</option>
          <option>GnD-C6</option>
          <option>GnD-C1</option>

          <option>Scan Coin-SC-360</option>
          <option>Cash Tek-ST-25</option>
          <option>LEA-BM-100</option>
          <option>Cash Quip-HL-3300</option>
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label small fw-bold">Serial Number</label>
        <input class="form-control sn" required>
      </div>

      <div class="col-md-2">
        <label class="form-label small fw-bold">Kondisi</label>
        <select class="form-select kondisi" required>
          <option value="">--Kondisi--</option>
          <option>Baik</option>
          <option>Rusak</option>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label small fw-bold">Lokasi</label>
        <select class="form-select lokasi" required>
          <option value="">--Lokasi--</option>
          <option>COU</option>
          <option>Remote</option>
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label small fw-bold">Lokasi Remote</label>
        <input class="form-control remote" >
      </div>

    </div>
  `;

  document.getElementById("mesinContainer").appendChild(div);
}

/* === SIMPAN DATA + VALIDASI TAMBAHAN (TANPA UBAH LOGIKA ASLI) === */
function simpanData() {

  let valid = true;

  document.querySelectorAll("[required]").forEach(el => {
    if (!el.value) {
      el.classList.add("is-invalid");
      valid = false;
    } else {
      el.classList.remove("is-invalid");
    }
  });

  if (!valid) {
    alert("⚠️ Semua field wajib diisi!");
    return;
  }

  document.getElementById("loadingOverlay").style.display = "flex";
  document.getElementById("btnSave").disabled = true;

  const mesin = [];
  document.querySelectorAll(".machine-card").forEach(card => {
    mesin.push({
      jenis: card.querySelector(".jenis").value,
      merk: card.querySelector(".merk").value,
      type: card.querySelector(".type").value,
      sn: card.querySelector(".sn").value,
      kondisi: card.querySelector(".kondisi").value,
      lokasi: card.querySelector(".lokasi").value,
      remote: card.querySelector(".remote").value,
    });
  });

  const payload = {
    region: region.value,
    nama_cou: namaCOU.value,
    kecukupan: kecukupan.value,
    saran: saran.value,
    mesin: mesin
  };

  fetch(webAppURL, {
    method: "POST",
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(() => {
    document.getElementById("loadingOverlay").style.display = "none";
    new bootstrap.Modal(document.getElementById("successModal")).show();
  })
  .catch(() => {
    document.getElementById("loadingOverlay").style.display = "none";
    document.getElementById("btnSave").disabled = false;
    alert("Gagal menyimpan data");
  });
}

/* DEFAULT 1 MESIN */
tambahMesin();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
